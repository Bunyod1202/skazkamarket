<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Orders</title>
  <link rel="stylesheet" href="/static/webapp/styles.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1 id="title">Mening buyurtmalarim</h1>
    </header>

    <main>
      <div id="orders"></div>
    </main>
  </div>

  <script>
    (function(){
      const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
      if (tg) tg.expand();

      const $list = document.getElementById('orders');
      const $title = document.getElementById('title');

      function getQueryTid(){ try{ const p=new URLSearchParams(location.search); const v=p.get('tid'); return v&&/^\d+$/.test(v)?v:null }catch(e){ return null } }
      function detectLang(){
        const lc = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.language_code) ? tg.initDataUnsafe.user.language_code : 'uz';
        return (lc||'uz').toLowerCase().startsWith('ru') ? 'RU' : 'UZ';
      }
      const lang = detectLang();
      if (lang === 'RU') $title.textContent = 'Мои заказы';

      function t(uz, ru, en){ return lang === 'RU' ? ru : (lang==='EN'? en : uz); }

      async function resolveTelegramId(){
        const u = tg && tg.initDataUnsafe ? tg.initDataUnsafe.user : null;
        if (u && u.id) return String(u.id);
        const tid = getQueryTid();
        if (tid) return tid;
        try{
          const params = new URLSearchParams(tg?.initData || '');
          const raw = params.get('user');
          if (raw){ const parsed = JSON.parse(decodeURIComponent(raw)); if (parsed && parsed.id) return String(parsed.id); }
        }catch(e){}
        return '';
      }

      async function load(){
        const tid = await resolveTelegramId();
        if (!tid){
          $list.innerHTML = `<p>${t('Iltimos, bot orqali oching', 'Откройте через бота', 'Open via bot')}</p>`;
          return;
        }
        try{
          const res = await fetch(`/api/my-orders?telegram_id=${tid}`);
          const data = await res.json();
          render(data.orders || []);
        }catch(e){
          console.error('orders failed', e);
          $list.innerHTML = `<p>${t('Xatolik yuz berdi', 'Произошла ошибка', 'An error occurred')}</p>`;
        }
      }

      function render(orders){
        if (!orders.length){
          $list.innerHTML = `<p>${t('Sizda buyurtmalar yo\'q.', 'У вас нет заказов.', 'You have no orders.')}</p>`;
          return;
        }
        const frag = document.createDocumentFragment();
        orders.forEach(o => {
          const card = document.createElement('div');
          card.className = 'card';
          const items = (o.items||[]).map(it => `${lang==='RU'?it.product_name_ru:it.product_name_uz} x${it.quantity}`).join('<br>');
          card.innerHTML = `
            <div class="content">
              <div class="name">#${o.id} · ${o.status} · ${new Date(o.created_at).toLocaleString()}</div>
              <div class="price">${t('Jami', 'Итого', 'Total')}: ${o.total}</div>
              <div class="items">${items}</div>
            </div>
          `;
          frag.appendChild(card);
        });
        $list.innerHTML = '';
        $list.appendChild(frag);
      }

      load();
    })();
  </script>
</body>
</html>
